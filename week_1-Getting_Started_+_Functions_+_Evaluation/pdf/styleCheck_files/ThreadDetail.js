define("bundles/discussions/components/discussionsBody/ThreadDetail",["require","exports","module","jsuri","react-router","react","underscore","bundles/discussions/actions/ThreadDetailsActions","bundles/discussions/components/discussionsBody/DetailedQuestion","bundles/discussions/components/SessionDetails","bundles/discussions/components/SoftDelete","bundles/discussions/components/profiles/ProfileArea","bundles/discussions/components/repliesList/RepliesList","bundles/discussions/components/repliesList/ReplyCMLInput","bundles/discussions/components/NextViewLink","bundles/discussions/components/ModerationDropdown","bundles/discussions/components/threadSettings/ThreadSettings","bundles/discussions/constants","bundles/discussions/utils/discussionsUrl","bundles/discussions/api/threadDetailsUtils","bundles/discussions/utils/unreadTracker","bundles/discussions/viewModels/viewContext","bundles/discussions/utils/discussionsApiRolloutUtil","i18n!nls/discussions","pages/open-course/common/models/currentSocialProfile","pages/open-course/common/promises/groupAuthorizationPromise","vendor/cnpm/fluxible.v0-4/addons/connectToStores","js/lib/connectToRouter","bundles/discussions/utils/routerConnectToCurrentForum","bundles/naptimejs/resources/onDemandCourseForums.v1","bundles/naptimejs/resources/onDemandMentorForums.v1","bundles/discussions/components/discussionsForumsHOC","css!bundles/discussions/components/discussionsBody/__styles__/ThreadDetail"],function(require,exports,module){"use strict";function _defaults(e,n){for(var i=Object.getOwnPropertyNames(n),s=0;s<i.length;s++){var t=i[s],o=Object.getOwnPropertyDescriptor(n,t);o&&o.configurable&&void 0===e[t]&&Object.defineProperty(e,t,o)}return e}function _classCallCheck(e,s){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(s,e){if(!s)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?s:e}function _inherits(s,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);s.prototype=Object.create(e&&e.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(s,e):_defaults(s,e))}var n,d,E=require("jsuri"),b=require("react-router"),I=b.Link,e=require("react"),_=require("underscore"),c=require("bundles/discussions/actions/ThreadDetailsActions"),A=c.fetchThread,s=c.fetchAnswers,l=require("bundles/discussions/components/discussionsBody/DetailedQuestion"),m=require("bundles/discussions/components/SessionDetails"),h=require("bundles/discussions/components/SoftDelete"),f=require("bundles/discussions/components/profiles/ProfileArea"),y=require("bundles/discussions/components/repliesList/RepliesList"),u=require("bundles/discussions/components/repliesList/ReplyCMLInput"),g=require("bundles/discussions/components/NextViewLink"),T=require("bundles/discussions/components/ModerationDropdown"),v=require("bundles/discussions/components/threadSettings/ThreadSettings"),t=require("bundles/discussions/constants"),p=t.savingStates,x=t.answerSorts,i=t.defaults,w=t.answers,a=t.naptimeForumTypes,S=require("bundles/discussions/utils/discussionsUrl"),P=S.buildUrl,C=require("bundles/discussions/api/threadDetailsUtils"),q=C.getAnswerPosition,D=require("bundles/discussions/utils/unreadTracker"),k=require("bundles/discussions/viewModels/viewContext"),R=require("bundles/discussions/utils/discussionsApiRolloutUtil"),o=R.useNewForumApis,N=require("i18n!nls/discussions"),r=require("pages/open-course/common/models/currentSocialProfile"),F=require("pages/open-course/common/promises/groupAuthorizationPromise"),U=require("vendor/cnpm/fluxible.v0-4/addons/connectToStores"),M=require("js/lib/connectToRouter"),j=require("bundles/discussions/utils/routerConnectToCurrentForum"),L=require("bundles/naptimejs/resources/onDemandCourseForums.v1"),O=require("bundles/naptimejs/resources/onDemandMentorForums.v1"),B=require("bundles/discussions/components/discussionsForumsHOC"),z=w.limitPerPage;require("css!bundles/discussions/components/discussionsBody/__styles__/ThreadDetail");var V=(d=n=function(t){function ThreadDetail(){var o,s,n;_classCallCheck(this,ThreadDetail);for(var i=arguments.length,r=Array(i),e=0;i>e;e++)r[e]=arguments[e];return o=s=_possibleConstructorReturn(this,t.call.apply(t,[this].concat(r))),s.state={canTeach:!1,inputClickCounter:0},n=o,_possibleConstructorReturn(s,n)}return _inherits(ThreadDetail,t),ThreadDetail.prototype.componentWillMount=function componentWillMount(){var t=this.props,u=t.questionId,n=t.sort,r=t.page,d=t.answerId,c=t.userId,a=t.courseId,e=t.currentForum;this.context.executeAction(A,{questionId:u,userId:c,courseId:a,sort:n,page:r,forumType:e&&e.forumType.typeName,forumUrlId:e&&e.urlId}),(!d&&!o()||1!==r||n!==i.detailSort)&&this.context.executeAction(s,{questionId:u,userId:c,courseId:a,sort:n,page:r,forumType:e&&e.forumType.typeName,forumUrlId:e&&e.urlId,includeDeleted:this.props.hasModerationRole})},ThreadDetail.prototype.componentDidMount=function componentDidMount(){this.markRead(),this.getRole(),this.fetchAnswerPosition(),this._isMounted=!0},ThreadDetail.prototype.componentWillReceiveProps=function componentWillReceiveProps(e){var o=e.questionId,n=e.userId,i=e.courseId,r=e.sort,u=e.page,t=e.currentForum;e.sort!==this.props.sort||e.page!==this.props.page?this.context.executeAction(s,{questionId:o,userId:n,courseId:i,sort:r,page:u,forumType:t&&t.forumType.typeName,includeDeleted:this.props.hasModerationRole}):this.props.answerSavingState===p.SAVING&&e.answerSavingState===p.SAVED&&(this.context.executeAction(s,{questionId:o,userId:n,courseId:i,sort:r,page:u,forumType:t&&t.forumType.typeName,includeDeleted:this.props.hasModerationRole}),this.context.router.push({pathname:window.location.pathname,params:{},query:{sort:x.newestSort}}))},ThreadDetail.prototype.componentDidUpdate=function componentDidUpdate(e,t,s){(e.questionId!==this.props.questionId||e.currentForum&&e.currentForum.id!==this.props.currentForum.id||s.viewContext&&s.viewContext.get("id")!==this.context.viewContext.get("id"))&&this.markRead()},ThreadDetail.prototype.componentWillUnmount=function componentWillUnmount(){this._isMounted=!1},ThreadDetail.prototype.getRole=function getRole(){var e=this;if(this.context.viewContext&&"group"===this.context.viewContext.get("contentType")){var t=this.context.viewContext.get("model").id,s=this.props,o=s.authenticated,n=s.isSuperuser;F(t,o,n).then(function(s){e._isMounted&&e.setState({canTeach:s})})}else this.setState({canTeach:this.props.hasModerationRole})},ThreadDetail.prototype.getBackLinkDescription=function getBackLinkDescription(){if(o())return this.props.currentForum.title;var e=this.context.viewContext;return e.isType("item")||e.isType("question")?"Discussions":e.get("name")},ThreadDetail.prototype.fetchAnswerPosition=function fetchAnswerPosition(){var e=this,t=this.props,c=t.answerId,r=t.questionId,u=t.userId,a=t.courseId,n=t.currentForum,l=t.currentForumUrl,p=t.sort,d=t.page;if(!c)return;q(c,p,z).then(function(t){t===d?e.context.executeAction(s,{questionId:r,userId:u,courseId:a,sort:p,page:d,forumType:n&&n.forumType.typeName,forumUrlId:n&&n.urlId,includeDeleted:e.props.hasModerationRole}):e.context.router.replace({pathname:e.context.router.location.pathname,params:{},query:Object.assign(_.object(new E(e.context.router.location.search).queryPairs),{page:t})})}).fail(function(){var t=o()?l:e.context.viewContext.get("discussionsLink");e.context.router.replace(P(t,r)),e.context.executeAction(s,{userId:u,courseId:a,questionId:r,sort:i.detailSort,page:i.detailPage,forumType:n&&n.forumType.typeName,includeDeleted:e.props.hasModerationRole})}).done()},ThreadDetail.prototype.markRead=function markRead(){D.markRead(this.props.questionId)},ThreadDetail.prototype.render=function render(){var n=this,t=this.props,s=t.question,i=t.isClosed,c=t.isPinned,b=t.currentForumUrl,d=t.currentForum,p=o()?b:this.context.viewContext.get("discussionsLink"),g=d&&[a.mentorForumType,a.groupForumType].indexOf(d.forumType.typeName)<0;return e.createElement("div",{className:"rc-ThreadDetail"},this.state.canTeach&&s&&e.createElement(m,{isPinned:c,question:s}),e.createElement("div",{className:"discussion-content"},e.createElement("div",{className:"horizontal-box align-items-vertical-center align-items-spacebetween"},e.createElement(I,{to:this.props.backLink,className:"back-area nostyle"},e.createElement("div",{className:"horizontal-box align-items-vertical-center"},e.createElement("i",{className:"back-arrow cif-arrow-left c-back-arrow-image"}),e.createElement("h4",{className:"headline-2-text c-back-label"},this.getBackLinkDescription()))),this.state.canTeach&&s&&e.createElement(v,{question:s,viewContext:this.context.viewContext,shouldShowMoveThread:g})),e.createElement("div",{className:"frost-container"},e.createElement("div",null,e.createElement(l,{goToInput:function goToInput(){return n.setState({inputClickCounter:n.state.inputClickCounter+1})},question:s,isPinned:c,forumLink:p}),i&&e.createElement("div",{className:"c-thread-locked card-no-action color-secondary-text"},e.createElement("div",{className:"horizontal-box align-items-absolute-center"},e.createElement("i",{className:"cif-lock"}),N("This thread is closed. You cannot add any more responses.")))),e.createElement("div",null,e.createElement(y,{sort:this.props.sort,page:this.props.page,questionId:this.props.questionId,answerId:this.props.answerId,commentId:this.props.commentId,forumLink:p}),!i&&e.createElement("div",{className:"reply-container horizontal-box"},e.createElement(f,{externalUserId:r.get("externalUserId"),fullName:r.get("fullName"),profileImageUrl:r.getProfileImageUrl()}),s&&e.createElement(u,{shouldFocusCounter:this.state.inputClickCounter,parentPost:s,savingState:this.props.answerSavingState})),s&&s.state&&s.state.deleted&&e.createElement(h,{entry:this.props.question,hideUndoDelete:!1})))))},ThreadDetail}(e.Component),n.propTypes={questionId:e.PropTypes.string.isRequired,sort:e.PropTypes.string.isRequired,page:e.PropTypes.number.isRequired,backLink:e.PropTypes.string.isRequired,authenticated:e.PropTypes.bool.isRequired,isSuperuser:e.PropTypes.bool.isRequired,answerSavingState:e.PropTypes.string,answerId:e.PropTypes.string,commentId:e.PropTypes.string,question:e.PropTypes.object,isClosed:e.PropTypes.bool,isPinned:e.PropTypes.bool,courseId:e.PropTypes.string,userId:e.PropTypes.number,currentForum:e.PropTypes.oneOfType([e.PropTypes.instanceOf(L),e.PropTypes.instanceOf(O)]),currentForumUrl:e.PropTypes.string,hasModerationRole:e.PropTypes.bool},n.contextTypes={viewContext:e.PropTypes.instanceOf(k),executeAction:e.PropTypes.func.isRequired,router:e.PropTypes.object.isRequired},d);module.exports=_.compose(U(["ThreadDetailsStore","ThreadSettingsStore","CourseStore","ApplicationStore"],function(e,i){var o=e.ThreadDetailsStore,n=e.ThreadSettingsStore,u=e.CourseStore,s=e.ApplicationStore,r=i.questionId,t=o.getQuestion(r);return{question:t,answerSavingState:t&&o.savingStates[t.id],isClosed:n.isClosed(),isPinned:n.isPinned(),userId:s.getUserData().id,authenticated:s.isAuthenticatedUser(),isSuperuser:s.isSuperuser()}}),B({fields:["link","title"],subcomponents:[g,u,T]}),M(j))(V)});